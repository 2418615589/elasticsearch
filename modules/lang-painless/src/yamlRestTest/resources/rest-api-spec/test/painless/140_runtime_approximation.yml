setup:
  - do:
      indices.create:
        index: test
        body:
          settings:
            number_of_replicas: 0
            number_of_shards: 1 # One shard gets us much more consistent profiling output
          mappings:
            properties:
              node:
                type: keyword
              tx:
                type: long

  - do:
      bulk:
        refresh: true
        index: test
        body:
          - '{"index": {}}'
          - '{"node": "a", "tx": 2001818691, "neighbours": 5}'
          - '{"index": {}}'
          - '{"node": "b", "tx": 2001818691, "neighbours": 3}'
          - '{"index": {}}'
          - '{"node": "c", "tx": 3001818691, "neighbours": 6}'
          - '{"index": {}}'
          - '{"node": "d", "tx": 4001818691}'
          - '{"index": {}}'
          - '{"node": "e", "tx": 5001818691}'
          - '{"index": {}}'
          - '{"node": "f", "tx": 6001818691}'
          - '{"index": {}}'
          - '{"node": "g", "tx": 7001818691}'

---
constant matching none:
  - do:
      search:
        index: test
        body:
          profile: true
          runtime_mappings:
            constant:
              type: long
              script: emit(0)
              approximate_first: true
          query:
            range:
              constant:
                gt: 1
  - match: { hits.total.value: 0 }
  - match: { profile.shards.0.searches.0.query.0.type: LongScriptFieldRangeQuery }
  - match: { profile.shards.0.searches.0.query.0.description: 'constant:[2 TO 9223372036854775807] approximated by MatchNoDocsQuery("value [0] is not between [2] and [9223372036854775807]")' }
  # match=0 means we never ran the script because the approximation claimed it couldn't possibly match any documents
  - match: { profile.shards.0.searches.0.query.0.breakdown.match_count: 0 }

---
division matching none:
  - do:
      search:
        index: test
        body:
          profile: true
          runtime_mappings:
            tx.kb:
              type: long
              script: emit(doc.tx.value / 1024l)
              approximate_first: true
          query:
            range:
              tx.kb:
                gte: 100
                lte: 200
  - match: { hits.total.value: 0 }
  - match: { profile.shards.0.searches.0.query.0.type: LongScriptFieldRangeQuery }
  - match: { profile.shards.0.searches.0.query.0.description: 'tx.kb:[100 TO 200] approximated by tx:[102400 TO 205823] (-ConstantScore(DocValuesFieldExistsQuery [field=tx]) #*:*)' }
  # match=0 means we never ran the script because the approximation claimed it couldn't possibly match any documents
  - match: { profile.shards.0.searches.0.query.0.breakdown.match_count: 0 }

---
division matching one:
  - do:
      search:
        index: test
        body:
          profile: true
          runtime_mappings:
            tx.kb:
              type: long
              script: emit(doc.tx.value / 1024l)
              approximate_first: true
          query:
            range:
              tx.kb:
                gt: 6837712
  - match: { hits.total.value: 1 }
  - match: { profile.shards.0.searches.0.query.0.type: LongScriptFieldRangeQuery }
  - match: { profile.shards.0.searches.0.query.0.description: 'tx.kb:[6837713 TO 9223372036854775807] approximated by tx:[7001818112 TO 9223372036854775807] (-ConstantScore(DocValuesFieldExistsQuery [field=tx]) #*:*)' }
  # match=1 means we only ever had to run the script one time
  - match: { profile.shards.0.searches.0.query.0.breakdown.match_count: 1 }

---
division matching two:
  - do:
      search:
        index: test
        body:
          profile: true
          runtime_mappings:
            tx.kb:
              type: long
              script: emit(doc.tx.value / 1024l)
              approximate_first: true
          query:
            range:
              tx.kb:
                lt: 1954902
  - match: { hits.total.value: 2 }
  - match: { profile.shards.0.searches.0.query.0.type: LongScriptFieldRangeQuery }
  - match: { profile.shards.0.searches.0.query.0.description: 'tx.kb:[-9223372036854775808 TO 1954901] approximated by tx:[-9223372036854775808 TO 2001819647] (-ConstantScore(DocValuesFieldExistsQuery [field=tx]) #*:*)' }
  # match=1 means we only ever had to run the script twice - once for each possible match
  - match: { profile.shards.0.searches.0.query.0.breakdown.match_count: 2 }

---
addition with missing value:
  - do:
      catch: bad_request
      search:
        index: test
        body:
          profile: true
          runtime_mappings:
            known_nodes:
              type: long
              script: emit(doc.neighbours.value + 1l)
              approximate_first: true
          query:
            range:
              known_nodes:
                gt: 3
  - match: { error.root_cause.0.type: "script_exception" }
  - match: { error.root_cause.0.reason: "runtime error" }

---
guarded addition with missing value:
  - do:
      search:
        index: test
        body:
          profile: true
          runtime_mappings:
            known_nodes:
              type: long
              script: if(doc.neighbours.size() > 0) { emit(doc.neighbours.value + 1l) }
              approximate_first: true
          query:
            term:
              known_nodes: 6
  - match: { hits.total.value: 1 }
  - match: { profile.shards.0.searches.0.query.0.type: LongScriptFieldTermQuery }
  - match: { profile.shards.0.searches.0.query.0.description: 'known_nodes:6 approximated by neighbours:[5 TO 5] (-ConstantScore(DocValuesFieldExistsQuery [field=neighbours]) #*:*)' }
  - match: { profile.shards.0.searches.0.query.0.breakdown.match_count: 5 }
